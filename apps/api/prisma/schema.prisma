generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  MANAGER
  DATA_ENTRY
}

enum ProjectStatus {
  DRAFT
  ACTIVE
  COMPLETED
  ARCHIVED
}

enum NodeType {
  GOAL
  OUTCOME
  OUTPUT
  ACTIVITY
}

enum IndicatorDataType {
  NUMBER
  PERCENT
  TEXT
  BOOLEAN
  CATEGORICAL
}

enum AnomalyStatus {
  DETECTED
  ACKNOWLEDGED
  RESOLVED
  FALSE_POSITIVE
}

enum ImportType {
  INDICATOR_DEFINITION
  SUBMISSION
}

enum ImportStatus {
  PENDING
  VALIDATING
  VALIDATED
  IMPORTING
  COMPLETED
  FAILED
  CANCELLED
}

enum ImportMode {
  CREATE_ONLY
  UPSERT
}

enum RowStatus {
  PENDING
  VALID
  WARNING
  ERROR
  IMPORTED
  SKIPPED
}

model User {
  id                      Int       @id @default(autoincrement())
  email                   String    @unique
  passwordHash            String
  role                    Role
  name                    String?
  jobTitle                String?
  organization            String?
  timezone                String?
  avatar                  String?
  notificationPreferences Json?
  createdAt               DateTime  @default(now())
  submissions             Submission[]
  anomalyReviews          Submission[] @relation("AnomalyReviews")
  importJobs              ImportJob[]
  importTemplates         ImportTemplate[]
  exportTemplates         ExportTemplate[]
}

model Project {
  id             Int            @id @default(autoincrement())
  name           String
  description    String?
  status         ProjectStatus  @default(DRAFT)
  startDate      DateTime?
  endDate        DateTime?
  sectors        String[]       @default([])
  location       String?
  donor          String?
  budgetAmount   Float?
  budgetCurrency String?
  createdAt      DateTime       @default(now())
  nodes          LogframeNode[]
  indicators     Indicator[]
}

model LogframeNode {
  id          Int          @id @default(autoincrement())
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId   Int
  type        NodeType
  title       String
  description String?
  parent      LogframeNode? @relation("LogframeHierarchy", fields: [parentId], references: [id])
  parentId    Int?
  children    LogframeNode[] @relation("LogframeHierarchy")
  sortOrder   Int           @default(0)
  createdAt   DateTime      @default(now())
  indicators  Indicator[]

  @@index([projectId])
  @@index([parentId])
}

model Indicator {
  id             Int               @id @default(autoincrement())
  project        Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId      Int
  logframeNode   LogframeNode      @relation(fields: [logframeNodeId], references: [id], onDelete: Cascade)
  logframeNodeId Int
  name           String
  unit           String
  baselineValue  Float?            // For numeric types
  targetValue    Float?            // For numeric types
  baselineCategory String?         // For CATEGORICAL type
  targetCategory String?           // For CATEGORICAL type
  dataType       IndicatorDataType
  minValue       Float?
  maxValue       Float?
  anomalyConfig  Json?
  validationConfig Json?           // Canonical validation rules
  categories     Json?             // For CATEGORICAL type: array of category definitions
  categoryConfig Json?             // For CATEGORICAL type: configuration (allowMultiple, maxSelections, etc.)
  createdAt      DateTime          @default(now())
  submissions    Submission[]
  importTemplates ImportTemplate[]
  importJobs     ImportJob[]
  exportTemplates ExportTemplate[]

  @@index([projectId])
  @@index([logframeNodeId])
}

model Submission {
  id              Int      @id @default(autoincrement())
  indicator       Indicator @relation(fields: [indicatorId], references: [id], onDelete: Cascade)
  indicatorId     Int
  reportedAt      DateTime
  value           String
  categoryValue   String?          // For CATEGORICAL type
  disaggregationKey String?        // For disaggregated data
  evidence        String?
  createdByUser   User     @relation(fields: [createdByUserId], references: [id], onDelete: Cascade)
  createdByUserId Int
  sourceImportJob ImportJob? @relation(fields: [sourceImportJobId], references: [id], onDelete: SetNull)
  sourceImportJobId Int?           // Tracks which import created this record
  createdAt       DateTime @default(now())
  
  isAnomaly        Boolean        @default(false)
  anomalyReason    String?
  anomalyStatus    AnomalyStatus?
  anomalyReviewedBy Int?
  anomalyReviewedAt DateTime?
  reviewer         User?          @relation("AnomalyReviews", fields: [anomalyReviewedBy], references: [id])

  @@unique([indicatorId, reportedAt, disaggregationKey])
  @@index([indicatorId])
  @@index([anomalyReviewedBy])
  @@index([sourceImportJobId])
}

model ImportTemplate {
  id              Int       @id @default(autoincrement())
  indicator       Indicator @relation(fields: [indicatorId], references: [id], onDelete: Cascade)
  indicatorId     Int
  name            String
  description     String?
  isDefault       Boolean   @default(false)
  columnMapping   Json
  createdBy       User      @relation(fields: [createdByUserId], references: [id])
  createdByUserId Int
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  importJobs      ImportJob[]
  
  @@index([indicatorId])
  @@index([createdByUserId])
}

model ImportJob {
  id              Int           @id @default(autoincrement())
  importType      ImportType
  indicator       Indicator?    @relation(fields: [indicatorId], references: [id], onDelete: Cascade)
  indicatorId     Int?
  template        ImportTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  templateId      Int?
  user            User          @relation(fields: [userId], references: [id])
  userId          Int
  fileName        String
  fileSize        Int
  totalRows       Int
  processedRows   Int           @default(0)
  successfulRows  Int           @default(0)
  failedRows      Int           @default(0)
  warningRows     Int           @default(0)
  status          ImportStatus  @default(PENDING)
  importMode      ImportMode    @default(CREATE_ONLY)
  createdAt       DateTime      @default(now())
  completedAt     DateTime?
  
  stagingRows     ImportJobRow[]
  submissions     Submission[]
  
  @@index([indicatorId])
  @@index([userId])
  @@index([status])
}

model ImportJobRow {
  id               Int       @id @default(autoincrement())
  job              ImportJob @relation(fields: [jobId], references: [id], onDelete: Cascade)
  jobId            Int
  rowNumber        Int
  rawData          Json
  normalizedData   Json?
  validationStatus RowStatus @default(PENDING)
  errors           Json?
  warnings         Json?
  createdAt        DateTime  @default(now())
  
  @@unique([jobId, rowNumber])
  @@index([jobId])
  @@index([validationStatus])
}

model ExportTemplate {
  id              Int       @id @default(autoincrement())
  indicator       Indicator @relation(fields: [indicatorId], references: [id], onDelete: Cascade)
  indicatorId     Int
  name            String
  description     String?
  isDefault       Boolean   @default(false)
  columnConfig    Json
  filterConfig    Json?
  formatConfig    Json?
  createdBy       User      @relation(fields: [createdByUserId], references: [id])
  createdByUserId Int
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([indicatorId])
  @@index([createdByUserId])
}
