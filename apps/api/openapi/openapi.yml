openapi: 3.0.3
info:
  title: MERLIN Lite API
  version: 1.0.0
servers:
  - url: http://localhost:4000/api/v1
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    User:
      type: object
      properties:
        id: { type: integer }
        email: { type: string, format: email }
        role: { type: string, enum: [ADMIN, MANAGER, DATA_ENTRY] }
        createdAt: { type: string, format: date-time }
    Project:
      type: object
      properties:
        id: { type: integer }
        name: { type: string }
        description: { type: string, nullable: true }
        status: { type: string, enum: [DRAFT, ACTIVE, COMPLETED, ARCHIVED] }
        startDate: { type: string, format: date-time, nullable: true }
        endDate: { type: string, format: date-time, nullable: true }
        sectors:
          type: array
          items: { type: string }
        location: { type: string, nullable: true }
        donor: { type: string, nullable: true }
        budgetAmount: { type: number, nullable: true }
        budgetCurrency: { type: string, nullable: true }
        createdAt: { type: string, format: date-time }
    LogframeNode:
      type: object
      properties:
        id: { type: integer }
        projectId: { type: integer }
        type: { type: string, enum: [GOAL, OUTCOME, OUTPUT, ACTIVITY] }
        title: { type: string }
        description: { type: string, nullable: true }
        parentId: { type: integer, nullable: true }
        sortOrder: { type: integer }
        createdAt: { type: string, format: date-time }
        children:
          type: array
          items:
            $ref: "#/components/schemas/LogframeNode"
    AnomalyConfig:
      type: object
      properties:
        enabled: { type: boolean, default: false }
        outlier:
          type: object
          properties:
            method: { type: string, enum: [MAD, IQR], default: MAD }
            threshold: { type: number, default: 3.5 }
            windowSize: { type: integer, default: 8, minimum: 2, maximum: 50 }
            minPoints: { type: integer, default: 6, minimum: 2 }
        trend:
          type: object
          properties:
            method:
              {
                type: string,
                enum: [SLOPE_SHIFT, MEAN_SHIFT],
                default: SLOPE_SHIFT,
              }
            threshold: { type: number, default: 2 }
            windowSize: { type: integer, default: 6, minimum: 3, maximum: 50 }
    CategoryDefinition:
      type: object
      properties:
        id: { type: string }
        label: { type: string }
        color: { type: string }
        description: { type: string }
    CategoryConfig:
      type: object
      properties:
        allowMultiple: { type: boolean }
        maxSelections: { type: integer, minimum: 1 }
        required: { type: boolean }
        allowOther: { type: boolean }
    Indicator:
      type: object
      properties:
        id: { type: integer }
        projectId: { type: integer }
        logframeNodeId: { type: integer }
        name: { type: string }
        unit: { type: string }
        baselineValue: { type: number, nullable: true }
        targetValue: { type: number, nullable: true }
        dataType:
          { type: string, enum: [NUMBER, PERCENT, TEXT, BOOLEAN, CATEGORICAL] }
        minValue: { type: number, nullable: true }
        maxValue: { type: number, nullable: true }
        anomalyConfig:
          allOf:
            - $ref: "#/components/schemas/AnomalyConfig"
          nullable: true
        categories:
          type: array
          items:
            $ref: "#/components/schemas/CategoryDefinition"
          nullable: true
        categoryConfig:
          allOf:
            - $ref: "#/components/schemas/CategoryConfig"
          nullable: true
        createdAt: { type: string, format: date-time }
    CategoryStats:
      type: object
      properties:
        categoryId: { type: string }
        label: { type: string }
        count: { type: integer }
        percentage: { type: number }
    IndicatorStats:
      type: object
      properties:
        submissionCount: { type: integer }
        anomalyCount: { type: integer }
        anomalyRate: { type: number }
        lastSubmissionDate: { type: string, format: date-time }
        currentValue: { type: number, nullable: true }
        progressToTarget: { type: number, nullable: true }
        progressFromBaseline: { type: number, nullable: true }
        average: { type: number, nullable: true }
        min: { type: number, nullable: true }
        max: { type: number, nullable: true }
        categoryDistribution:
          type: array
          items:
            $ref: "#/components/schemas/CategoryStats"
        mostFrequent:
          type: object
          properties:
            categoryId: { type: string }
            label: { type: string }
            count: { type: integer }
          nullable: true
        trend:
          {
            type: string,
            enum: [increasing, decreasing, stable],
            nullable: true,
          }
    Submission:
      type: object
      properties:
        id: { type: integer }
        indicatorId: { type: integer }
        reportedAt: { type: string, format: date }
        value: { type: string }
        evidence: { type: string, nullable: true }
        createdByUserId: { type: integer }
        createdAt: { type: string, format: date-time }
        isAnomaly: { type: boolean, default: false }
        anomalyReason: { type: string, nullable: true }
        anomalyStatus:
          {
            type: string,
            enum: [DETECTED, ACKNOWLEDGED, RESOLVED, FALSE_POSITIVE],
            nullable: true,
          }
        anomalyReviewedBy: { type: integer, nullable: true }
        anomalyReviewedAt: { type: string, format: date-time, nullable: true }
    ReportingGap:
      type: object
      properties:
        from: { type: string, format: date-time }
        to: { type: string, format: date-time }
        daysMissing: { type: integer }
        expectedSubmissions: { type: integer }
paths:
  /auth/login:
    post:
      summary: Login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email: { type: string, format: email }
                password: { type: string }
      responses:
        "200":
          description: Access token
          content:
            application/json:
              schema:
                type: object
                properties:
                  token: { type: string }
                  user:
                    $ref: "#/components/schemas/User"
  /auth/register:
    post:
      security: [{ bearerAuth: [] }]
      summary: Create user (ADMIN only)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email: { type: string, format: email }
                password: { type: string }
                role:
                  type: string
                  enum: [ADMIN, MANAGER, DATA_ENTRY]
      responses:
        "201": { description: Created }
  /auth/me:
    get:
      security: [{ bearerAuth: [] }]
      summary: Current user
      responses:
        "200":
          description: Current user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
  /projects:
    get:
      security: [{ bearerAuth: [] }]
      summary: List projects
      responses:
        "200":
          description: Projects
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Project" }
    post:
      security: [{ bearerAuth: [] }]
      summary: Create project (ADMIN, MANAGER)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Project"
      responses:
        "201": { description: Created }
  /projects/{id}:
    get:
      security: [{ bearerAuth: [] }]
      summary: Get project
      parameters:
        - in: path
          name: id
          schema: { type: integer }
          required: true
      responses:
        "200":
          description: Project
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Project" }
    patch:
      security: [{ bearerAuth: [] }]
      summary: Update project (ADMIN, MANAGER)
      parameters:
        - in: path
          name: id
          schema: { type: integer }
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/Project" }
      responses:
        "200": { description: Updated }
    delete:
      security: [{ bearerAuth: [] }]
      summary: Delete project (ADMIN, MANAGER)
      parameters:
        - in: path
          name: id
          schema: { type: integer }
          required: true
      responses:
        "200": { description: Deleted }
  /projects/{projectId}/logframe/nodes:
    post:
      security: [{ bearerAuth: [] }]
      summary: Create logframe node (ADMIN, MANAGER)
      parameters:
        - in: path
          name: projectId
          schema: { type: integer }
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LogframeNode"
      responses:
        "201": { description: Created }
  /projects/{projectId}/logframe/tree:
    get:
      security: [{ bearerAuth: [] }]
      summary: Get logframe tree
      parameters:
        - in: path
          name: projectId
          schema: { type: integer }
          required: true
      responses:
        "200":
          description: Tree
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/LogframeNode" }
  /logframe/nodes/{id}:
    patch:
      security: [{ bearerAuth: [] }]
      summary: Update logframe node (ADMIN, MANAGER)
      parameters:
        - in: path
          name: id
          schema: { type: integer }
          required: true
      responses:
        "200": { description: Updated }
    delete:
      security: [{ bearerAuth: [] }]
      summary: Delete logframe node (ADMIN)
      parameters:
        - in: path
          name: id
          schema: { type: integer }
          required: true
      responses:
        "204": { description: Deleted }
  /projects/{projectId}/indicators:
    post:
      security: [{ bearerAuth: [] }]
      summary: Create indicator (ADMIN, MANAGER)
      parameters:
        - in: path
          name: projectId
          schema: { type: integer }
          required: true
      responses:
        "201": { description: Created }
    get:
      security: [{ bearerAuth: [] }]
      summary: List indicators
      parameters:
        - in: path
          name: projectId
          schema: { type: integer }
          required: true
      responses:
        "200": { description: Indicators }
  /indicators/{id}:
    get:
      security: [{ bearerAuth: [] }]
      summary: Get indicator
      parameters:
        - in: path
          name: id
          schema: { type: integer }
          required: true
      responses:
        "200":
          description: Indicator
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Indicator" }
    patch:
      security: [{ bearerAuth: [] }]
      summary: Update indicator (ADMIN, MANAGER)
      parameters:
        - in: path
          name: id
          schema: { type: integer }
          required: true
      responses:
        "200": { description: Updated }
  /indicators/{id}/stats:
    get:
      security: [{ bearerAuth: [] }]
      summary: Get indicator with statistics
      parameters:
        - in: path
          name: id
          schema: { type: integer }
          required: true
      responses:
        "200":
          description: Indicator with stats
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/Indicator"
                  - type: object
                    properties:
                      stats:
                        allOf:
                          - $ref: "#/components/schemas/IndicatorStats"
                        nullable: true
  /indicators/{id}/gaps:
    get:
      security: [{ bearerAuth: [] }]
      summary: Detect reporting gaps for an indicator
      parameters:
        - in: path
          name: id
          schema: { type: integer }
          required: true
        - in: query
          name: frequency
          schema:
            { type: string, enum: [DAILY, WEEKLY, MONTHLY], default: MONTHLY }
        - in: query
          name: includeSubmissions
          schema: { type: boolean, default: true }
      responses:
        "200":
          description: Reporting gaps analysis
          content:
            application/json:
              schema:
                type: object
                properties:
                  indicatorId: { type: integer }
                  frequency: { type: string }
                  totalSubmissions: { type: integer }
                  gaps:
                    type: array
                    items: { $ref: "#/components/schemas/ReportingGap" }
  /indicators/{id}/category-distribution:
    get:
      security: [{ bearerAuth: [] }]
      summary: Get category distribution for CATEGORICAL indicators
      parameters:
        - in: path
          name: id
          schema: { type: integer }
          required: true
      responses:
        "200":
          description: Category distribution statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  indicatorId: { type: integer }
                  indicatorName: { type: string }
                  categories:
                    type: array
                    items:
                      $ref: "#/components/schemas/CategoryDefinition"
                  distribution:
                    type: array
                    items:
                      $ref: "#/components/schemas/CategoryStats"
                  mostFrequent:
                    type: object
                    properties:
                      categoryId: { type: string }
                      label: { type: string }
                      count: { type: integer }
                    nullable: true
                  totalSubmissions: { type: integer }
        "400":
          description: Not a categorical indicator
  /indicators/{indicatorId}/submissions:
    post:
      security: [{ bearerAuth: [] }]
      summary: Create submission (all authenticated)
      parameters:
        - in: path
          name: indicatorId
          schema: { type: integer }
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                reportedAt: { type: string, format: date }
                value:
                  {
                    oneOf:
                      [{ type: string }, { type: number }, { type: boolean }],
                  }
                evidence: { type: string, nullable: true }
      responses:
        "201":
          description: Created with anomaly detection result
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Submission" }
    get:
      security: [{ bearerAuth: [] }]
      summary: List submissions with anomaly flags
      parameters:
        - in: path
          name: indicatorId
          schema: { type: integer }
          required: true
        - in: query
          name: from
          schema: { type: string, format: date }
        - in: query
          name: to
          schema: { type: string, format: date }
      responses:
        "200":
          description: Submissions
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Submission" }
  /submissions/{id}/anomaly/acknowledge:
    post:
      security: [{ bearerAuth: [] }]
      summary: Acknowledge an anomaly
      parameters:
        - in: path
          name: id
          schema: { type: integer }
          required: true
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                notes: { type: string }
      responses:
        "200":
          description: Anomaly acknowledged
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Submission" }
  /submissions/{id}/anomaly/resolve:
    post:
      security: [{ bearerAuth: [] }]
      summary: Resolve an anomaly
      parameters:
        - in: path
          name: id
          schema: { type: integer }
          required: true
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                notes: { type: string }
      responses:
        "200":
          description: Anomaly resolved
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Submission" }
  /submissions/{id}/anomaly/false-positive:
    post:
      security: [{ bearerAuth: [] }]
      summary: Mark an anomaly as false positive
      parameters:
        - in: path
          name: id
          schema: { type: integer }
          required: true
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                notes: { type: string }
      responses:
        "200":
          description: Anomaly marked as false positive
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Submission" }
  /submissions/{id}/anomaly/status:
    put:
      security: [{ bearerAuth: [] }]
      summary: Update anomaly status
      parameters:
        - in: path
          name: id
          schema: { type: integer }
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [status]
              properties:
                status:
                  {
                    type: string,
                    enum: [DETECTED, ACKNOWLEDGED, RESOLVED, FALSE_POSITIVE],
                  }
                notes: { type: string }
      responses:
        "200":
          description: Status updated
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Submission" }
security:
  - bearerAuth: []
